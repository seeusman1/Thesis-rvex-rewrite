

TRACE UNIT INTERFACE

*** Syscon ***
in  reset
in  clk
in  clkEn

*** Control ***
in  valid(context) = commit(context) and not stall(context)
out stallOut

*** Configuration (from control regs)
in  trace_ena(context)
in  trace_trap(context)
in  trace_mem(context)
in  trace_regs(context)

*** Input data (from pipelanes) ***
in  ctxt(lane)(2 downto 0)
in  PC(lane)(31 downto 0)
in  trap_data(lane)(trap data record)
in  rfi(lane)
in  mem_ena(lane)
in  mem_addr(lane)(31 downto 0)
in  mem_wmask(lane)(3 downto 0)
in  mem_wdata(lane)(31 downto 0)
in  gprl_wena(lane)
in  gprl_addr(lane)(5 downto 0) (0 for link)
in  gprl_wdata(lane)
in  br_wena(lane)(7 downto 0)
in  br_wdata(lane)(7 downto 0)

*** Compressed output data stream ***
out tracePush
out traceData(7 downto 0)
in  traceBusy




TRACE PROTOCOL

*** Header data ***

FLAGS:
 - Bit 7: Trap fields valid
 - Bit 6: Memory operation fields valid
 - Bit 5: General purpose/link register write fields valid
 - Bit 4: Branch register field valid
 - Bit 3: Reserved for extended flag field validity, should be 0
 - Bit 2..0: The context being logged

PC0:
 - Bit 7..2: PC(7..2)
 - Bit 1..0: number of PC bytes valid

[PC1] if PC0(1..0) >= 1:
[PC2] if PC0(1..0) >= 2:
[PC3] if PC0(1..0) >= 3:
 - Bit 7..0: PC

*** Trap fields if FLAGS(7) = 1 ***

[TC]:
 - Bit 7..0: trap cause; a zero is used here to indicate RFI

[TA0] if TC != 0:
[TA1] if TC != 0:
[TA2] if TC != 0:
[TA3] if TC != 0:
 - Bit 7..0: trap argument

*** Memory operation fields if FLAGS(6) = 1 or previous MEMFLAGS(7) = 1 ***

[MEMFLAGS]:
 - Bit 7: repeat; another memory operation field section will follow if 1.
 - Bit 3..0: write mask + validity
 
[MEMADDR0]:
[MEMADDR1]:
[MEMADDR2]:
[MEMADDR3]:
 - Bit 7..0: memory address

[MEMDATA0] if MEMFLAGS(0) = 1:
[MEMDATA1] if MEMFLAGS(1) = 1:
[MEMDATA2] if MEMFLAGS(2) = 1:
[MEMDATA3] if MEMFLAGS(3) = 1:
 - Bit 7..0: memory data

*** General purpose register write fields if FLAGS(5) = 1 or previous GPWFLAGS(7) = 1 ***

[GPWFLAGS]
 - Bit 7: repeat; another general purpose register write field section will follow if 1.
 - Bit 5..0: register index; 0 is used for link register
 
[GPWDATA0]:
[GPWDATA1]:
[GPWDATA2]:
[GPWDATA3]:
 - Bit 7..0: gpreg/link data

*** Branch register field if FLAGS(4) = 1 ***

[BRWMASK]
 - Bit 7..0: 1 if indexed branch register is written, 0 if not

[BRWDATA]
 - Bit 7..0: new value for the indexed branch register
