
top: help

# User configuration.
config.makefile:
	@if [ ! -f $@ ]; then \
		echo "" > $@; \
		echo "# User configuration file. This file is ignored by git and generated by makefile" >> $@; \
		echo "# if it does not exist." >> $@; \
		echo "" >> $@; \
		echo "# Vivado setup. Vivado 2015.2 is assumed, but other versions may work. The" >> $@; \
		echo "# makefiles will automatically source Vivado's environment script only when they" >> $@; \
		echo "# need it, because Vivado's environment breaks some standard tools." >> $@; \
		echo "VIVADO_ENV = /opt/applics/bin/xilinx-vivado-2015.2.sh" >> $@; \
		echo "" >> $@; \
		echo "# The following is used as the hostname of the Zedboard by the zed-ssh target." >> $@; \
		echo "# If not defined here, it should be defined when calling make." >> $@; \
		echo "#ZED_HOST = 192.168.0.x" >> $@; \
		echo "" >> $@; \
		echo "# The following is used by the zed-sdcard target as the SD card device file. You" >> $@; \
		echo "# should ONLY define this if it is always the same on your system, otherwise you" >> $@; \
		echo "# may end up formatting the wrong device!" >> $@; \
		echo "#ZED_SD_DEV = /dev/mmcblk0" >> $@; \
		echo "" >> $@; \
		echo "Created default config.makefile."; \
	fi
-include config.makefile

# Tools.
include tools.makefile

# IP directories.
IP            += rvex
IP            += tta

# Zedboard directory.
ZED            = zed


#-------------------------------------------------------------------------------
# Housekeeping
#-------------------------------------------------------------------------------

.PHONY: help
help:
	@echo ""
	@echo " Targets:"
	@echo ""
	@echo "  ip                : compiles all IP blocks."
	@echo ""
	@echo "  ip-<ip>           : compiles the given IP block."
	@echo ""
	@echo "  sim-<ip>          : simulates the given IP block with modelsim. Please source"
	@echo "                      the modelsim environment script before running this."
	@echo ""
	@echo "  zed-configure     : opens the programmable logic block diagram in Vivado, to"
	@echo "                      let you configure the PL peripherals for the Zedboard."
	@echo ""
	@echo "  zed               : builds all files needed to make the bootable SD card for"
	@echo "                      the Zedboard. This includes the PL bitfile, u-boot and"
	@echo "                      the Linux kernel. Linaro is downloaded pre-built."
	@echo ""
	@echo "  zed-sdcard        : correctly formats an SD card for the Zedboard. This needs"
	@echo "                      root permissions. The target will ask you for the SD card"
	@echo "                      device file unless you specified it in config.makefile,"
	@echo "                      and ALWAYS asks for confirmation."
	@echo ""
	@echo "  zed-ssh           : shortcut to SSH to the Zedboard. You will need to install"
	@echo "                      openssh-server with apt-get on the board before this will"
	@echo "                      work."
	@echo ""
	@echo "  clean             : removes all generated files."
	@echo ""
	@echo "  dl-clean          : removes all downloaded files."
	@echo ""

.PHONY: clean
clean: zed-clean $(patsubst %,clean-%,$(IP))

.PHONY: dl-clean
dl-clean: zed-dl-clean


#-------------------------------------------------------------------------------
# IP blocks
#-------------------------------------------------------------------------------

.PHONY: ip
ip: $(patsubst %,ip-%,$(IP))

.PHONY: clean-%
clean-%: %
	cd $< && $(MAKE) clean

.PHONY: ip-%
ip-%: %
	cd $< && $(MAKE) all

.PHONY: sim-%
sim-%: %
	cd $< && $(MAKE) sim


#-------------------------------------------------------------------------------
# zed/ directory targets
#-------------------------------------------------------------------------------

.PHONY: zed-configure
zed-configure: ip
	cd zed && $(MAKE) configure

.PHONY: zed
zed: ip
	cd zed && $(MAKE) all

.PHONY: zed-%
zed-%:
	cd zed && $(MAKE) $(patsubst zed-%,%,$@)
