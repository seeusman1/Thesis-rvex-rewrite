
top: help

# User configuration.
config.makefile:
	@if [ ! -f $@ ]; then \
		echo "" > $@; \
		echo "# User configuration file. This file is ignored by git and generated by makefile" >> $@; \
		echo "# if it does not exist." >> $@; \
		echo "" >> $@; \
		echo "# Vivado setup. Vivado 2015.2 is assumed, but other versions may work. The" >> $@; \
		echo "# makefiles will automatically source Vivado's environment script only when they" >> $@; \
		echo "# need it, because Vivado's environment breaks some standard tools." >> $@; \
		echo "VIVADO_ENV = /opt/applics/bin/xilinx-vivado-2015.2.sh" >> $@; \
		echo "" >> $@; \
		echo "# The following is used as the hostname of the Zedboard by the zed-ssh target." >> $@; \
		echo "# If not defined here, it should be defined when calling make." >> $@; \
		echo "#ZED_HOST = 192.168.0.x" >> $@; \
		echo "" >> $@; \
		echo "# The following is used by the zed-sdcard target as the SD card device file. You" >> $@; \
		echo "# should ONLY define this if it is always the same on your system, otherwise you" >> $@; \
		echo "# may end up formatting the wrong device!" >> $@; \
		echo "#ZED_SD_DEV = /dev/mmcblk0" >> $@; \
		echo "" >> $@; \
		echo "Created default config.makefile."; \
	fi
-include config.makefile

# Tools.
include tools.makefile

# IP directories. Adding an accelerator/IP block to the system involves the
# following:
#  - Adding the IP name here;
#  - Adding the IP project files to impl/<ip-name>/, along with a makefile to
#    build it (use the makefiles from the existing IP blocks as a template);
#  - Adding the IP repository to the zedboard PL project in
#    boards/zed/pl-project-gen.tcl. FIXME: this should probably be automated.
IP            += rvex
#IP            += tce  # Disabled because it's not compiling right now.

# Zedboard directory.
ZED            = boards/zed


#-------------------------------------------------------------------------------
# Housekeeping
#-------------------------------------------------------------------------------

.PHONY: help
help:
	@echo ""
	@echo " Targets:"
	@echo ""
	@echo "  all               : currently the same as zed, see below."
	@echo ""
	@echo "  ip                : compiles all IP blocks."
	@echo ""
	@echo "  ip-<ip>           : compiles the given IP block."
	@echo ""
	@echo "  sim-<ip>          : simulates the given IP block with modelsim. Please source"
	@echo "                      the modelsim environment script before running this."
	@echo ""
	@echo "  zed-configure     : opens the programmable logic block diagram in Vivado, to"
	@echo "                      let you configure the PL peripherals for the Zedboard."
	@echo ""
	@echo "  zed               : builds all files needed to make the bootable SD card for"
	@echo "                      the Zedboard. This includes the PL bitfile, u-boot and"
	@echo "                      the Linux kernel. Linaro is downloaded pre-built."
	@echo ""
	@echo "  zed-sdcard        : formats an SD card for the Zedboard. This needs root"
	@echo "                      permissions. The target will ask you for the SD card"
	@echo "                      device file unless you specified it in config.makefile,"
	@echo "                      and ALWAYS asks for confirmation."
	@echo ""
	@echo "  zed-ssh           : shortcut to SSH to the Zedboard. You will need to install"
	@echo "                      openssh-server with apt-get on the board before this will"
	@echo "                      work."
	@echo ""
	@echo "  clean             : removes all generated files."
	@echo ""
	@echo "  dl-clean          : removes all downloaded files."
	@echo ""

.PHONY: all
all: zed

.PHONY: clean
clean: zed-clean $(patsubst %,clean-%,$(IP))

.PHONY: dl-clean
dl-clean: zed-dl-clean


#-------------------------------------------------------------------------------
# IP blocks
#-------------------------------------------------------------------------------

.PHONY: ip
ip: $(patsubst %,ip-%,$(IP))

.PHONY: clean-%
clean-%: impl/%
	cd $< && $(MAKE) clean

.PHONY: ip-%
ip-%: impl/%
	cd $< && $(MAKE) all

.PHONY: sim-%
sim-%: impl/%
	cd $< && $(MAKE) sim


#-------------------------------------------------------------------------------
# boards/zed directory targets
#-------------------------------------------------------------------------------

.PHONY: zed-configure
zed-configure: ip
	cd $(ZED) && $(MAKE) configure

.PHONY: zed
zed: ip
	cd $(ZED) && $(MAKE) all

.PHONY: zed-%
zed-%:
	cd $(ZED) && $(MAKE) $(patsubst zed-%,%,$@)

